<html>
  <head>
    <title>MVVM，RxJava 和 Retrofit 的一次实践 - haohao</title>
    <link href='/images/ic_small.png' rel='shortcut icon'>
<link href='/atom.xml' rel='alternate' type='application/rss+xml'>
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/responsive.css">
<script src="/js/jquery.js"></script>
<script src="/js/basics.js"></script>
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type'>


	<script src="/prettify/prettify.js" type="text/javascript"></script>
	<link rel="stylesheet" href="/themes/tomorrow-night-eighties.css" type="text/css">
  </head>
  <body>
    <header>
  <a id='go-back-home' href='/'><img src='/images/ic_middle.png' alt='Home' width='96' height='96'></a>
  <p>haohao</p>
  <p>不忘初心，不惧未来</p>
</header>

    <div id='container'>
      <div class='block'>
  
    <a class='main' href='/'>Home</a>
  
    <a class='main' href='/me'>About</a>
  
    <a class='main' href='mailto:haohaochang86@gmail.com'>Email</a>
  
    <a class='main' href='https://github.com/githubhaohao'>Github</a>
  
</div>

      <section class='paging'>
  
    <div class='left'>
      <a href='/2017/02/17/Android主题切换和多主题实现/'>
        ‹
      </a>
    </div>
  
  
    <div class='right'>
      <a href='/2017/01/25/ES6入门-需要掌握的基本语法/'>
        ›
      </a>
    </div>
  
</section>

      <div class='content'>
        <section class='post'>
          <h1>
            <div class='date'>2017-02-12</div>
            MVVM，RxJava 和 Retrofit 的一次实践
          </h1>
          <p><img src="https://github.com/githubhaohao/ImageRoom/blob/master/Images/country-1295915__340.png?raw=true" alt="Cover"></p>
<p align="center">春节后的第一篇博客</p>

<blockquote>
<p>本文已授权微信公众号：鸿洋（hongyangAndroid）原创首发。<br>原创文章，转载请注明出处:<a href="http://haohaochang.cn/2017/02/12/MVVM%EF%BC%8CRxJava%E5%92%8CRetrofit%E7%9A%84%E4%B8%80%E6%AC%A1%E5%AE%9E%E8%B7%B5/" target="_blank" rel="external">haohaochang.cn</a></p>
</blockquote>
<hr>
<h2 id="效果预览"><a href="#效果预览" class="headerlink" title="效果预览"></a>效果预览</h2><p><img src="https://github.com/githubhaohao/MVVMRxJavaRetrofitSample/blob/master/image/sample.gif?raw=true" alt="result"></p>
<p><a href="https://github.com/githubhaohao/MVVMRxJavaRetrofitSample/blob/master/demo.apk" target="_blank" rel="external">Demo 下载</a></p>
<h2 id="准备知识"><a href="#准备知识" class="headerlink" title="准备知识"></a>准备知识</h2><h3 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h3><p><img src="https://github.com/githubhaohao/ImageRoom/blob/master/Images/mvvm/mvc.PNG?raw=true" alt="mvc"></p>
<ul>
<li><strong>视图层（View）</strong>：用户界面。</li>
<li><strong>控制器层（Controller）</strong>：业务逻辑</li>
<li><strong>模型层（Model）</strong>：数据保存</li>
</ul>
<hr>
<ol>
<li>View 层传送指令到 Controller 层</li>
<li>Controller 层完成业务逻辑后，要求 Model 层改变状态</li>
<li>Model 层将新的数据发送到 View层，使用户得到反馈</li>
</ol>
<p><strong>缺陷</strong>:View 层和 Model 层是相互可知，耦合性大，像 Activity 或者 Fragment 既在 Controller 层，又在 View 层，造成工程的可扩展性可维护性非常差。</p>
<h3 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a>MVP</h3><p><img src="https://github.com/githubhaohao/ImageRoom/blob/master/Images/mvvm/mvp.png?raw=true" alt="mvp"></p>
<p>在 MVP 架构模式中，Controller 层变成了 Presenter 层。</p>
<ol>
<li>MVP 模式各层之间的通信，都是双向的。</li>
<li>View 层与 Model 层不直接发生联系，都通过 Presenter 层进行间接通信。</li>
<li>Model 层与 Presenter 层，Presenter 层与 View 层之间通过接口建立联系。</li>
</ol>
<p>采用 MVP 模式，Activity 与 Fragment 只位于 View 层。</p>
<p><strong>MVP 的缺陷在于</strong>:由于我们使用了接口的方式去连接 View 层和  Presenter 层，这样就导致了特定场景下的一些问题，当你的页面逻辑很复杂的时候，你的 View 层实现的接口会有很多，如果你的 App 中有很多个这样复杂的页面，维护接口的成本就会变的非常的大。</p>
<h3 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h3><p><img src="https://github.com/githubhaohao/ImageRoom/blob/master/Images/mvvm/mvvp.PNG?raw=true" alt="MVVM"></p>
<p>MVVM 模式将 Presenter 改名为 ViewModel，基本上与 MVP 模式完全一致。<br><strong>区别在于</strong>: View 层与 ViewModel 层通过 DataBinding 相互绑定，View 层的变动，自动反映在 ViewModel 层，反之亦然。</p>
<h3 id="RxJava"><a href="#RxJava" class="headerlink" title="RxJava"></a><a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="external">RxJava</a></h3><p><img src="https://github.com/githubhaohao/ImageRoom/blob/master/Images/mvvm/kotlin-android-rxjava.png?raw=true" alt="RxJava"></p>
<blockquote>
<p>Rx 是微软 .Net 的一个响应式扩展，Rx 借助可观测的序列提供一种简单的方式来创建异步的，基于事件驱动的程序。2012 年 Netflix 为了应对不断增长的业务需求开始将 .NET Rx 迁移到 JVM 上面。并于 13 年二月份正式向外展示了 RxJava 。</p>
<p>从语义的角度来看， RxJava 就是 .NET Rx 。从语法的角度来看， Netflix 考虑到了对应每个 Rx 方法,保留了 Java 代码规范和基本的模式。</p>
</blockquote>
<p>RxJava 在 GitHub 主页的介绍是：</p>
<blockquote>
<p>RxJava is a Java VM implementation of Reactive Extensions: a library for composing asynchronous and event-based programs by using observable sequences.</p>
</blockquote>
<p>一个在 Java VM 上使用可观测的序列来组成异步的、基于事件程序的库。</p>
<p>RxJava 本质上是一个异步操作库，是一个能让你用极其简洁的逻辑去处理繁琐复杂任务的异步事件库。</p>
<p>简而言之，RxJava 可以用几个关键字概括：<strong>简洁，队列化，异步</strong>。</p>
<h3 id="Retrofit"><a href="#Retrofit" class="headerlink" title="Retrofit"></a><a href="https://github.com/square/retrofit" target="_blank" rel="external">Retrofit</a></h3><p><img src="https://github.com/githubhaohao/ImageRoom/blob/master/Images/mvvm/android-libs-retrofit-1-638.jpg?raw=true" alt="retrofit"></p>
<p>一个 Android 和 Java 上 HTTP 库（利用注解和 OKHttp 来实现和服务器的数据交互）。</p>
<p>Retrofit 基于 OKHttp 并引入注解，使用简单，易扩展，易维护。</p>
<blockquote>
<p><a href="http://square.github.io/retrofit/" target="_blank" rel="external"><strong>Retrofit 官方文档:http://square.github.io/retrofit/</strong></a></p>
</blockquote>
<h3 id="DataBinding"><a href="#DataBinding" class="headerlink" title="DataBinding"></a><a href="https://developer.android.com/topic/libraries/data-binding/index.html" target="_blank" rel="external">DataBinding</a></h3><p><img src="https://github.com/githubhaohao/ImageRoom/blob/master/Images/mvvm/data_binding.png?raw=true" alt="data-binding"></p>
<p>在Google IO 2015 中，Google 在 support-v7 中新增了 Data Binding，使用 Data Binding可以直接在布局的 xml 中绑定布局与数据，从而简化代码，Android Data Binding是Android 的 MVVM 框架。因为 Data Binding 是包含在 support-v7 包里面的，所以可以向下兼容到最低 Android 2.1 (API level 7+).</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>直接上代码。</p>
<h3 id="依赖的第三方类库"><a href="#依赖的第三方类库" class="headerlink" title="依赖的第三方类库"></a>依赖的第三方类库</h3><pre><code class="gradle">    compile &#39;io.reactivex:rxjava:1.1.0&#39;
    compile &#39;io.reactivex:rxandroid:1.1.0&#39;
    compile &#39;com.squareup.retrofit2:retrofit:2.0.0-beta4&#39;
    compile &#39;com.squareup.retrofit2:converter-gson:2.0.0-beta4&#39;
    compile &#39;com.squareup.retrofit2:adapter-rxjava:2.0.0-beta4&#39;
    compile &#39;com.github.bumptech.glide:glide:3.7.0&#39;
</code></pre>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><blockquote>
<p><code>https://api.douban.com/v2/movie/top250?start=0&amp;count=20</code></p>
</blockquote>
<h3 id="引入DataBinding"><a href="#引入DataBinding" class="headerlink" title="引入DataBinding"></a>引入DataBinding</h3><pre><code class="gradle">android {
    ......

    dataBinding {
        enabled = true
    }
}
</code></pre>
<h3 id="工程目录结构"><a href="#工程目录结构" class="headerlink" title="工程目录结构"></a>工程目录结构</h3><p><img src="https://github.com/githubhaohao/ImageRoom/blob/master/Images/mvvm/%E7%9B%AE%E5%BD%95.png?raw=true" alt="目录"></p>
<blockquote>
<p>详细源码：<a href="https://github.com/githubhaohao/MVVMRxJavaRetrofitSample" target="_blank" rel="external">https://github.com/githubhaohao/MVVMRxJavaRetrofitSample</a></p>
</blockquote>
<h3 id="MVVM-之-View"><a href="#MVVM-之-View" class="headerlink" title="MVVM 之 View"></a>MVVM 之 View</h3><p><strong>MainActivity.java</strong></p>
<pre><code class="java">getFragmentManager().beginTransaction().add(R.id.movie_fragment, MovieFragment.getInstance()).commit();
</code></pre>
<p><strong>MovieFragment.java</strong></p>
<pre><code class="java">public class MovieFragment extends Fragment implements CompletedListener,SwipeRefreshLayout.OnRefreshListener{

    private static String TAG = MovieFragment.class.getSimpleName();
    private MainViewModel viewModel;
    private MovieFragmentBinding movieFragmentBinding;
    private MovieAdapter movieAdapter;

    public static MovieFragment getInstance() {
        return new MovieFragment();
    }

    @Nullable
    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
        View contentView = inflater.inflate(R.layout.movie_fragment, container, false);
        movieFragmentBinding = MovieFragmentBinding.bind(contentView);
        initData();
        return contentView;
    }

    private void initData() {
        movieAdapter = new MovieAdapter();
        movieFragmentBinding.recyclerView.setLayoutManager(new LinearLayoutManager(getActivity(), LinearLayoutManager.VERTICAL, false));
        movieFragmentBinding.recyclerView.setItemAnimator(new DefaultItemAnimator());
        movieFragmentBinding.recyclerView.setAdapter(movieAdapter);
        movieFragmentBinding.swipeRefreshLayout.setColorSchemeResources(R.color.colorAccent, R.color.colorPrimary, R.color.colorPrimaryDark);
        movieFragmentBinding.swipeRefreshLayout.setOnRefreshListener(this);
        viewModel = new MainViewModel(movieAdapter,this);
        movieFragmentBinding.setViewModel(viewModel);

    }

    @Override
    public void onRefresh() {
        movieAdapter.clearItems();
        viewModel.refreshData();
    }

    @Override
    public void onCompleted() {
        if (movieFragmentBinding.swipeRefreshLayout.isRefreshing()) {
            movieFragmentBinding.swipeRefreshLayout.setRefreshing(false);
        }
    }
}
</code></pre>
<p><strong>activity_main.xml</strong></p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;android.support.design.widget.CoordinatorLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:fitsSystemWindows=&quot;true&quot;
    tools:context=&quot;.view.MainActivity&quot;&gt;

    &lt;!-- ... --&gt;

    &lt;FrameLayout
        android:layout_marginTop=&quot;?attr/actionBarSize&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;match_parent&quot;
        android:id=&quot;@+id/movie_fragment&quot;/&gt;

    &lt;!-- ... --&gt;

&lt;/android.support.design.widget.CoordinatorLayout&gt;
</code></pre>
<p><strong>movie_fragment.xml</strong></p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;layout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;data&gt;
        &lt;variable
            name=&quot;viewModel&quot;
            type=&quot;com.jc.mvvmrxjavaretrofitsample.viewModel.MainViewModel&quot;/&gt;
    &lt;/data&gt;
    &lt;RelativeLayout
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;match_parent&quot;&gt;
        &lt;android.support.v4.widget.SwipeRefreshLayout
            android:visibility=&quot;@{viewModel.contentViewVisibility}&quot;
            android:id=&quot;@+id/swipe_refresh_layout&quot;
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;match_parent&quot;&gt;

            &lt;android.support.v7.widget.RecyclerView
                android:id=&quot;@+id/recycler_view&quot;
                android:background=&quot;#ddd&quot;
                android:layout_width=&quot;match_parent&quot;
                android:layout_height=&quot;match_parent&quot;
                android:padding=&quot;8dp&quot;&gt;
            &lt;/android.support.v7.widget.RecyclerView&gt;

        &lt;/android.support.v4.widget.SwipeRefreshLayout&gt;

        &lt;ProgressBar
            style=&quot;?android:attr/progressBarStyleLarge&quot;
            android:id=&quot;@+id/progress_bar&quot;
            android:visibility=&quot;@{viewModel.progressBarVisibility}&quot;
            android:layout_width=&quot;wrap_content&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:layout_centerInParent=&quot;true&quot;/&gt;

        &lt;LinearLayout
            android:layout_width=&quot;match_parent&quot;
            android:id=&quot;@+id/error_info_layout&quot;
            android:visibility=&quot;@{viewModel.errorInfoLayoutVisibility}&quot;
            android:orientation=&quot;vertical&quot;
            android:layout_height=&quot;match_parent&quot;&gt;
            &lt;TextView
                android:layout_gravity=&quot;center&quot;
                android:layout_width=&quot;wrap_content&quot;
                android:layout_height=&quot;wrap_content&quot;
                android:text=&quot;@{viewModel.exception}&quot;/&gt;
        &lt;/LinearLayout&gt;
    &lt;/RelativeLayout&gt;
&lt;/layout&gt;
</code></pre>
<p><strong>movie_item.xml</strong></p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;layout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:app=&quot;http://schemas.android.com/tools&quot;&gt;
    &lt;data&gt;
        &lt;variable
            name=&quot;viewModel&quot;
            type=&quot;com.jc.mvvmrxjavaretrofitsample.viewModel.MovieViewModel&quot;/&gt;
    &lt;/data&gt;
    &lt;android.support.v7.widget.CardView
        xmlns:card_view=&quot;http://schemas.android.com/apk/res-auto&quot;
        android:id=&quot;@+id/card_view&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        card_view:cardCornerRadius=&quot;4dp&quot;
        card_view:cardBackgroundColor=&quot;@color/background&quot;
        card_view:cardUseCompatPadding=&quot;true&quot;&gt;
        &lt;LinearLayout
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;wrap_content&quot;
            android:orientation=&quot;horizontal&quot;&gt;
            &lt;ImageView
                android:layout_margin=&quot;8dp&quot;
                android:layout_width=&quot;60dp&quot;
                android:layout_height=&quot;100dp&quot;
                android:src=&quot;@drawable/cover&quot;
                app:imageUrl=&quot;@{viewModel.imageUrl}&quot;
                android:id=&quot;@+id/cover&quot;/&gt;
            &lt;LinearLayout
                android:layout_width=&quot;wrap_content&quot;
                android:layout_height=&quot;match_parent&quot;
                android:layout_margin=&quot;8dp&quot;
                android:orientation=&quot;vertical&quot;&gt;
                &lt;TextView
                    android:textColor=&quot;@android:color/black&quot;
                    android:layout_width=&quot;wrap_content&quot;
                    android:layout_height=&quot;wrap_content&quot;
                    android:text=&quot;@{viewModel.title}&quot;
                    android:textSize=&quot;12sp&quot;/&gt;
                &lt;LinearLayout
                    android:layout_width=&quot;wrap_content&quot;
                    android:layout_height=&quot;wrap_content&quot;
                    android:layout_marginTop=&quot;4dp&quot;
                    android:orientation=&quot;horizontal&quot;&gt;
                    &lt;android.support.v7.widget.AppCompatRatingBar
                        android:id=&quot;@+id/ratingBar&quot;
                        style=&quot;?android:attr/ratingBarStyleSmall&quot;
                        android:layout_width=&quot;wrap_content&quot;
                        android:layout_height=&quot;wrap_content&quot;
                        android:layout_gravity=&quot;center_vertical&quot;
                        android:isIndicator=&quot;true&quot;
                        android:max=&quot;10&quot;
                        android:numStars=&quot;5&quot;
                        android:rating=&quot;@{viewModel.rating}&quot; /&gt;

                    &lt;TextView
                        android:id=&quot;@+id/rating_text&quot;
                        android:layout_width=&quot;wrap_content&quot;
                        android:layout_height=&quot;wrap_content&quot;
                        android:layout_gravity=&quot;center_vertical&quot;
                        android:layout_marginLeft=&quot;6dp&quot;
                        android:text=&quot;@{viewModel.ratingText}&quot;
                        android:textColor=&quot;?android:attr/textColorSecondary&quot;
                        android:textSize=&quot;10sp&quot; /&gt;

                &lt;/LinearLayout&gt;
                &lt;TextView
                    android:layout_width=&quot;wrap_content&quot;
                    android:layout_height=&quot;wrap_content&quot;
                    android:textColor=&quot;?android:attr/textColorSecondary&quot;
                    android:textSize=&quot;10sp&quot;
                    android:text=&quot;@{viewModel.movieType}&quot;
                    android:id=&quot;@+id/movie_type_text&quot;
                    android:layout_marginTop=&quot;6dp&quot;
                    /&gt;
                &lt;TextView
                    android:layout_width=&quot;wrap_content&quot;
                    android:layout_height=&quot;wrap_content&quot;
                    android:textColor=&quot;?android:attr/textColorSecondary&quot;
                    android:textSize=&quot;10sp&quot;
                    android:text=&quot;@{viewModel.year}&quot;
                    android:id=&quot;@+id/year_text&quot;
                    android:layout_marginTop=&quot;6dp&quot;
                    /&gt;
            &lt;/LinearLayout&gt;

        &lt;/LinearLayout&gt;

    &lt;/android.support.v7.widget.CardView&gt;
&lt;/layout&gt;
</code></pre>
<p><strong>MovieAdapter.java</strong></p>
<pre><code class="java">public class MovieAdapter extends RecyclerView.Adapter&lt;MovieAdapter.BindingHolder&gt; {
    private List&lt;Movie&gt; movies;

    public MovieAdapter() {
        movies = new ArrayList&lt;&gt;();
    }

    @Override
    public BindingHolder onCreateViewHolder(ViewGroup parent, int viewType) {
        MovieItemBinding itemBinding = DataBindingUtil.inflate(LayoutInflater.from(parent.getContext()), R.layout.movie_item, parent, false);
        return new BindingHolder(itemBinding);
    }

    @Override
    public void onBindViewHolder(BindingHolder holder, int position) {
        MovieViewModel movieViewModel = new MovieViewModel(movies.get(position));
        holder.itemBinding.setViewModel(movieViewModel);
    }

    @Override
    public int getItemCount() {
        return movies.size();
    }

    public void addItem(Movie movie) {
        movies.add(movie);
        notifyItemInserted(movies.size() - 1);
    }

    public void clearItems() {
        movies.clear();
        notifyDataSetChanged();
    }

    public static class BindingHolder extends RecyclerView.ViewHolder {
        private MovieItemBinding itemBinding;

        public BindingHolder(MovieItemBinding itemBinding) {
            super(itemBinding.cardView);
            this.itemBinding = itemBinding;
        }
    }
}
</code></pre>
<p>回调接口<strong> CompletedListener.java</strong></p>
<pre><code class="java">public interface CompletedListener {
    void onCompleted();
}
</code></pre>
<h3 id="MVVM-之-ViewModel"><a href="#MVVM-之-ViewModel" class="headerlink" title="MVVM 之 ViewModel"></a>MVVM 之 ViewModel</h3><p><strong>MainViewModel.java</strong></p>
<pre><code class="java">public class MainViewModel {
    public ObservableField&lt;Integer&gt; contentViewVisibility;
    public ObservableField&lt;Integer&gt; progressBarVisibility;
    public ObservableField&lt;Integer&gt; errorInfoLayoutVisibility;
    public ObservableField&lt;String&gt; exception;
    private Subscriber&lt;Movie&gt; subscriber;
    private MovieAdapter movieAdapter;
    private CompletedListener completedListener;

    public MainViewModel(MovieAdapter movieAdapter,CompletedListener completedListener) {
        this.movieAdapter = movieAdapter;
        this.completedListener = completedListener;
        initData();
        getMovies();
    }

    private void getMovies() {
        subscriber = new Subscriber&lt;Movie&gt;() {
            @Override
            public void onCompleted() {
                Log.d(&quot;[MainViewModel]&quot;, &quot;onCompleted&quot;);
                hideAll();
                contentViewVisibility.set(View.VISIBLE);
                completedListener.onCompleted();
            }

            @Override
            public void onError(Throwable e) {
                hideAll();
                errorInfoLayoutVisibility.set(View.VISIBLE);
                exception.set(e.getMessage());
            }

            @Override
            public void onNext(Movie movie) {
                movieAdapter.addItem(movie);
            }
        };
        RetrofitHelper.getInstance().getMovies(subscriber, 0, 20);
    }

    public void refreshData() {
        getMovies();
    }

    private void initData() {
        contentViewVisibility = new ObservableField&lt;&gt;();
        progressBarVisibility = new ObservableField&lt;&gt;();
        errorInfoLayoutVisibility = new ObservableField&lt;&gt;();
        exception = new ObservableField&lt;&gt;();
        contentViewVisibility.set(View.GONE);
        errorInfoLayoutVisibility.set(View.GONE);
        progressBarVisibility.set(View.VISIBLE);
    }

    private void hideAll(){
        contentViewVisibility.set(View.GONE);
        errorInfoLayoutVisibility.set(View.GONE);
        progressBarVisibility.set(View.GONE);
    }
}
</code></pre>
<p><strong>MovieViewModel.java</strong></p>
<pre><code class="java">public class MovieViewModel extends BaseObservable {
    private Movie movie;

    public MovieViewModel(Movie movie) {
        this.movie = movie;
    }

    public String getCoverUrl() {
        return movie.getImages().getSmall();
    }

    public String getTitle() {
        return movie.getTitle();
    }

    public float getRating() {
        return movie.getRating().getAverage();
    }

    public String getRatingText(){
        return String.valueOf(movie.getRating().getAverage());
    }

    public String getYear() {
        return movie.getYear();
    }

    public String getMovieType() {
        StringBuilder builder = new StringBuilder();
        for (String s : movie.getGenres()) {
            builder.append(s + &quot; &quot;);
        }
        return builder.toString();
    }

    public String getImageUrl() {
        return movie.getImages().getSmall();
    }

    @BindingAdapter({&quot;app:imageUrl&quot;})
    public static void loadImage(ImageView imageView,String url) {
        Glide.with(imageView.getContext())
                .load(url)
                .placeholder(R.drawable.cover)
                .error(R.drawable.cover)
                .into(imageView);

    }
}
</code></pre>
<h3 id="MVVM-之-Model"><a href="#MVVM-之-Model" class="headerlink" title="MVVM 之 Model"></a>MVVM 之 Model</h3><p><strong>DouBanMovieService.java</strong></p>
<pre><code class="java">public interface DouBanMovieService {
    String BASE_URL = &quot;https://api.douban.com/v2/movie/&quot;;

    @GET(&quot;top250&quot;)
    Observable&lt;Response&lt;List&lt;Movie&gt;&gt;&gt; getMovies(@Query(&quot;start&quot;) int start, @Query(&quot;count&quot;) int count);
}
</code></pre>
<p><strong>RetrofitHelper.java</strong></p>
<pre><code class="java">public class RetrofitHelper {
    private static final int DEFAULT_TIMEOUT = 10;
    private Retrofit retrofit;
    private DouBanMovieService movieService;
    OkHttpClient.Builder builder;

    /**
     * 获取RetrofitHelper对象的单例
     * */
    private static class Singleton {
        private static final RetrofitHelper INSTANCE = new RetrofitHelper();
    }

    public static RetrofitHelper getInstance() {
        return Singleton.INSTANCE;
    }

    public RetrofitHelper() {
        builder = new OkHttpClient.Builder();
        builder.connectTimeout(DEFAULT_TIMEOUT, TimeUnit.SECONDS);

        retrofit = new Retrofit.Builder()
                .client(builder.build())
                .addConverterFactory(GsonConverterFactory.create())
                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())
                .baseUrl(DouBanMovieService.BASE_URL)
                .build();
        movieService = retrofit.create(DouBanMovieService.class);
    }

    public void getMovies(Subscriber&lt;Movie&gt; subscriber, int start, int count) {
        movieService.getMovies(start, count)
                .map(new Func1&lt;Response&lt;List&lt;Movie&gt;&gt;, List&lt;Movie&gt;&gt;() {
                    @Override
                    public List&lt;Movie&gt; call(Response&lt;List&lt;Movie&gt;&gt; listResponse) {
                        return listResponse.getSubjects();
                    }
                })
                .flatMap(new Func1&lt;List&lt;Movie&gt;, Observable&lt;Movie&gt;&gt;() {
                    @Override
                    public Observable&lt;Movie&gt; call(List&lt;Movie&gt; movies) {
                        return Observable.from(movies);
                    }
                })
                .subscribeOn(Schedulers.io())
                .observeOn(AndroidSchedulers.mainThread())
                .subscribe(subscriber);
    }
}
</code></pre>
<p>还有 entity 类，这里就不贴出来了。</p>
<blockquote>
<p>详细源码：<a href="https://github.com/githubhaohao/MVVMRxJavaRetrofitSample" target="_blank" rel="external">https://github.com/githubhaohao/MVVMRxJavaRetrofitSample</a></p>
</blockquote>

          <br>
<p align="center">haohao</p>
<div class='date' align="center">2017-02-12</div>

        </section>
      </div>
      <div class='block'>
  
    <a class='main' href='/'>Home</a>
  
    <a class='main' href='/me'>About</a>
  
    <a class='main' href='mailto:haohaochang86@gmail.com'>Email</a>
  
    <a class='main' href='https://github.com/githubhaohao'>Github</a>
  
</div>

    </div>
    <footer>
  <span class='muted'>&copy; 2017 Powered by haohao</span><br>
  <br>

</footer>

	<script type="text/javascript">
	  $(window).load(function(){
         $('pre').addClass('prettyprint').attr('style', 'overflow:auto;');
         prettyPrint();
      })
	  
	  $(".block .main").hover(function() {
          $(this).css({"background-color" : "#ddd"});
        },function() {
          $(this).css({"background-color" : "white"});
		});	
	</script>
  </body>
</html>
